<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="300"> <title>Dashboard de Recolha</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: sans-serif; margin: 0; padding: 20px; }
        .header-stats { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1e293b; padding: 20px; border-radius: 12px; border-left: 8px solid #3b82f6; min-width: 250px; text-align: center; }
        .stat-card h2 { margin: 0; font-size: 1.4rem; color: #94a3b8; }
        .stat-val { font-size: 3.5rem; font-weight: bold; margin-top: 10px; }
        
        table { width: 100%; border-collapse: collapse; background: #1e293b; border-radius: 12px; overflow: hidden; font-size: 1.6rem; }
        th { background-color: #334155; color: #3b82f6; padding: 20px; text-align: left; }
        td { padding: 20px; border-bottom: 1px solid #334155; }
        tr:nth-child(even) { background-color: #1e293b; }
        .verde { color: #4ade80; font-weight: bold; }
        .laranja { color: #fb923c; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-stats">
        <div class="stat-card">
            <h2>Total de Postos (CNPJ)</h2>
            <div id="total-postos" class="stat-val">--</div>
        </div>
        <div class="stat-card" style="border-left-color: #4ade80;">
            <h2>Meta Batida (>90%)</h2>
            <div id="meta-90" class="stat-val" style="color: #4ade80;">--</div>
        </div>
    </div>

    <table id="tabela-dados">
        <thead>
            <tr>
                <th>Analista</th>
                <th>Valor a Recolher</th>
                <th>% Recolhido</th>
                <th>% Pendente</th>
            </tr>
        </thead>
        <tbody id="corpo-tabela">
            <tr><td colspan="4" style="text-align:center;">Carregando dados do Excel...</td></tr>
        </tbody>
    </table>

    <script>
        // NOME DO SEU ARQUIVO EXCEL NO GITHUB
        const arquivoExcel = 'dados.xlsx'; 

        async function lerExcel() {
            try {
                // Busca o arquivo Excel do seu repositório
                const response = await fetch(arquivoExcel + '?t=' + new Date().getTime());
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});

                // Pega a primeira aba da planilha
                const nomeAba = workbook.SheetNames[0];
                const aba = workbook.Sheets[nomeAba];
                
                // Converte para JSON (Lista de objetos)
                const lista = XLSX.utils.sheet_to_json(aba);

                let htmlTabela = "";
                let acima90 = 0;

                lista.forEach(row => {
                    // AJUSTE OS NOMES ABAIXO PARA BATER COM O CABEÇALHO DO SEU EXCEL
                    const analista = row['USUARIO RESPONSAVEL'] || '---';
                    const valor = row['VALOR A RECOLHER'] || '0';
                    const recolhido = row['% RECOLHIDO'] || 0;
                    const pendente = row['% PENDENTE'] || 0;

                    // Lógica para contar quem está acima de 90%
                    // Aceita formatos como "95%" ou 0.95
                    let percNum = typeof recolhido === 'string' ? parseFloat(recolhido.replace('%','')) : recolhido * 100;
                    if (percNum >= 90) acima90++;

                    htmlTabela += `<tr>
                        <td>${analista}</td>
                        <td>${valor}</td>
                        <td class="verde">${typeof recolhido === 'number' ? (recolhido * 100).toFixed(1) + '%' : recolhido}</td>
                        <td class="laranja">${typeof pendente === 'number' ? (pendente * 100).toFixed(1) + '%' : pendente}</td>
                    </tr>`;
                });

                document.getElementById('corpo-tabela').innerHTML = htmlTabela;
                document.getElementById('total-postos').innerText = lista.length;
                document.getElementById('meta-90').innerText = acima90;

            } catch (e) {
                console.error("Erro ao ler Excel:", e);
                document.getElementById('corpo-tabela').innerHTML = "Erro ao carregar o arquivo dados.xlsx";
            }
        }

        // Executa ao abrir
        lerExcel();
    </script>
</body>
</html>
