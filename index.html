<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="300"> 
    <title>Ranking de Recolha - Google Sheets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root { --bg: #050a14; --card: #111827; --accent: #3b82f6; --success: #10b981; --text: #f3f4f6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow: hidden; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: var(--card); border-bottom: 3px solid var(--accent); height: 80px; box-sizing: border-box; }
        .summary-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; padding: 20px 30px; height: 160px; box-sizing: border-box; }
        .stat-box { background: var(--card); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #1f2937; }
        .stat-value { font-size: 3.8rem; font-weight: 800; color: var(--accent); line-height: 1; }
        #scroll-container { height: calc(100vh - 240px); overflow-y: hidden; padding: 0 30px 100px 30px; position: relative; }
        table { width: 100%; border-collapse: collapse; font-size: 1.6rem; }
        th { padding: 20px; text-align: left; background: #1f2937; color: var(--accent); position: sticky; top: 0; z-index: 10; font-size: 1.1rem; }
        td { padding: 22px 20px; border-bottom: 1px solid #1f2937; background: var(--card); }
        tr:first-child td { background: #1e293b; border-left: 10px solid #ffd700; }
        .bar-container { background: #374151; border-radius: 10px; height: 20px; width: 150px; display: inline-block; margin-right: 15px; vertical-align: middle; }
        .bar-fill { height: 100%; border-radius: 10px; background: var(--success); }
        .success-text { color: var(--success); font-weight: bold; }
        .badge-meta { background: #064e3b; color: #6ee7b7; padding: 6px 15px; border-radius: 8px; font-weight: bold; border: 1px solid #059669; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; font-size: 2.2rem;">RANKING DE RECOLHA EM TEMPO REAL</h1>
        <div id="relogio" style="font-size: 1.3rem; color: #9ca3af;"></div>
    </div>

    <div class="summary-container">
        <div class="stat-box">
            <h2 style="margin:0; color:#9ca3af; font-size: 1.1rem; text-transform: uppercase;">Total de Postos</h2>
            <div id="total-geral-postos" class="stat-value">--</div>
        </div>
        <div class="stat-box">
            <h2 style="margin:0; color:#9ca3af; font-size: 1.1rem; text-transform: uppercase;">Postos com Meta > 90%</h2>
            <div id="total-meta-90" class="stat-value" style="color: var(--success);">--</div>
        </div>
    </div>

    <div id="scroll-container">
        <table>
            <thead>
                <tr>
                    <th>Analista</th>
                    <th>Postos</th>
                    <th>Meta Batida (>90%)</th>
                    <th>Total Recolhido</th>
                    <th>Eficiência</th>
                </tr>
            </thead>
            <tbody id="corpo-tabela">
                <tr><td colspan="5" style="text-align:center">Conectando ao Google Sheets...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        // COLE O SEU LINK CSV DO GOOGLE SHEETS ABAIXO:
        const urlGoogleSheets = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQqMA7au78v103iJZ-XxYPtClZYPYY9L-LWFND99qpLh-sbz1Eg-8Dbnky6uGAS4GO47fDEVs4qvaLy/pub?gid=1227728310&single=true&output=csv';

        function carregarDados() {
            Papa.parse(urlGoogleSheets, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    processarDados(results.data);
                },
                error: function(err) {
                    document.getElementById('corpo-tabela').innerHTML = "Erro ao conectar com a planilha pública.";
                }
            });
        }

        function processarDados(lista) {
            let analistasObj = {};
            let totalPostosGeral = lista.length;
            let totalMeta90Geral = 0;

            lista.forEach(row => {
                // Remove espaços e garante que os nomes das colunas batam exatamente com o CSV
                const nome = (row['USUARIO RESPONSAVEL'] || 'SEM ANALISTA').trim();
                const vlrRec = parseFloat((row['VALOR RECOLHIDO'] || '0').replace(/\./g, '').replace(',', '.'));
                const vlrTot = parseFloat((row['VALOR A RECOLHER'] || '0').replace(/\./g, '').replace(',', '.'));
                
                let efIndividual = vlrTot > 0 ? (vlrRec / vlrTot) * 100 : 0;
                let bateuMeta = efIndividual >= 90 ? 1 : 0;
                if (bateuMeta) totalMeta90Geral++;

                if (!analistasObj[nome]) {
                    analistasObj[nome] = { nome: nome, postos: 0, meta90: 0, recolhido: 0, total: 0 };
                }

                analistasObj[nome].postos += 1;
                analistasObj[nome].meta90 += bateuMeta;
                analistasObj[nome].recolhido += vlrRec;
                analistasObj[nome].total += vlrTot;
            });

            let ranking = Object.values(analistasObj).map(a => {
                a.eficiencia = a.total > 0 ? (a.recolhido / a.total) * 100 : 0;
                return a;
            }).sort((a, b) => b.eficiencia - a.eficiencia);

            let html = "";
            ranking.forEach(a => {
                html += `<tr>
                    <td><b>${a.nome}</b></td>
                    <td>${a.postos}</td>
                    <td><span class="badge-meta">${a.meta90} Postos</span></td>
                    <td class="success-text">R$ ${a.recolhido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    <td>
                        <div class="bar-container"><div class="bar-fill" style="width: ${a.eficiencia}%"></div></div>
                        <b>${a.eficiencia.toFixed(1)}%</b>
                    </td>
                </tr>`;
            });

            document.getElementById('corpo-tabela').innerHTML = html;
            document.getElementById('total-geral-postos').innerText = totalPostosGeral;
            document.getElementById('total-meta-90').innerText = totalMeta90Geral;
            document.getElementById('relogio').innerText = new Date().toLocaleString('pt-BR');

            iniciarScrollInfinito();
        }

        function iniciarScrollInfinito() {
            const container = document.getElementById('scroll-container');
            if (container.scrollHeight <= container.offsetHeight) return;
            let scrollPos = 0;
            let speed = 0.8; 
            function loop() {
                scrollPos += speed;
                container.scrollTop = scrollPos;
                if (scrollPos >= (container.scrollHeight - container.offsetHeight)) {
                    setTimeout(() => { scrollPos = 0; container.scrollTop = 0; setTimeout(() => { requestAnimationFrame(loop); }, 2000); }, 5000);
                } else { requestAnimationFrame(loop); }
            }
            requestAnimationFrame(loop);
        }

        carregarDados();
    </script>
</body>
</html>
