<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="300"> 
    <title>Dashboard de Recolha Profissional</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --bg: #050a14; --card: #111827; --accent: #3b82f6; --success: #10b981; --warning: #f59e0b; --text: #f3f4f6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 2px solid var(--accent); margin-bottom: 20px; }
        
        .summary-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        .stat-box { background: var(--card); padding: 20px; border-radius: 15px; text-align: center; border: 1px solid #1f2937; }
        .stat-box h2 { margin: 0; font-size: 1.2rem; color: #9ca3af; text-transform: uppercase; }
        .stat-value { font-size: 4rem; font-weight: 800; margin: 5px 0; color: var(--accent); }

        .table-container { background: var(--card); border-radius: 15px; padding: 10px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 1.2rem; }
        th { padding: 15px; text-align: left; background: #1f2937; color: var(--accent); text-transform: uppercase; font-size: 0.9rem; }
        td { padding: 15px; border-bottom: 1px solid #1f2937; }
        
        .bar-container { background: #374151; border-radius: 10px; height: 12px; width: 100px; display: inline-block; margin-right: 10px; }
        .bar-fill { height: 100%; border-radius: 10px; background: var(--success); }
        
        .negrito { font-weight: bold; }
        .success-text { color: var(--success); }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0">RECOLHA ANALISTAS</h1>
        <div id="relogio"></div>
    </div>

    <div class="summary-container">
        <div class="stat-box">
            <h2>Total de Postos (Geral)</h2>
            <div id="total-geral-postos" class="stat-value">--</div>
        </div>
        <div class="stat-box">
            <h2>Postos com Meta > 90%</h2>
            <div id="total-meta-90" class="stat-value" style="color: var(--success);">--</div>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Analista</th>
                    <th>Qtd Postos</th>
                    <th>Vlr Recolhido</th>
                    <th>Vlr Pendente</th>
                    <th>Eficiência</th>
                </tr>
            </thead>
            <tbody id="corpo-tabela">
                <tr><td colspan="5">Processando dados da planilha...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const arquivoExcel = 'dados.xlsx';

        async function processarDados() {
            try {
                const response = await fetch(arquivoExcel + '?t=' + new Date().getTime());
                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, {type: 'array'});
                const lista = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                let analistas = {};
                let totalPostosGeral = lista.length;
                let totalMeta90Geral = 0;

                lista.forEach(row => {
                    const nome = row['USUARIO RESPONSAVEL'] || 'SEM ANALISTA';
                    const vlrRecolhido = parseFloat(row['VALOR RECOLHIDO'] || 0);
                    const vlrPendente = parseFloat(row['VALOR PENDENTE'] || 0);
                    const vlrTotal = parseFloat(row['VALOR A RECOLHER'] || 0);
                    
                    // Cálculo de eficiência por posto para a meta de 90%
                    let efPosto = vlrTotal > 0 ? (vlrRecolhido / vlrTotal) * 100 : 0;
                    if (efPosto >= 90) totalMeta90Geral++;

                    if (!analistas[nome]) {
                        analistas[nome] = { postos: 0, recolhido: 0, pendente: 0, total: 0 };
                    }

                    analistas[nome].postos += 1;
                    analistas[nome].recolhido += vlrRecolhido;
                    analistas[nome].pendente += vlrPendente;
                    analistas[nome].total += vlrTotal;
                });

                let html = "";
                for (let a in analistas) {
                    let ef = analistas[a].total > 0 ? (analistas[a].recolhido / analistas[a].total) * 100 : 0;
                    
                    html += `<tr>
                        <td class="negrito">${a}</td>
                        <td>${analistas[a].postos}</td>
                        <td class="success-text">R$ ${analistas[a].recolhido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td style="color:#f87171">R$ ${analistas[a].pendente.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td>
                            <div class="bar-container"><div class="bar-fill" style="width: ${ef}%"></div></div>
                            ${ef.toFixed(1)}%
                        </td>
                    </tr>`;
                }

                document.getElementById('corpo-tabela').innerHTML = html;
                document.getElementById('total-geral-postos').innerText = totalPostosGeral;
                document.getElementById('total-meta-90').innerText = totalMeta90Geral;
                document.getElementById('relogio').innerText = new Date().toLocaleString();

            } catch (e) {
                document.getElementById('corpo-tabela').innerHTML = "Erro ao ler as colunas. Verifique os nomes no Excel.";
            }
        }

        processarDados();
    </script>
</body>
</html>
